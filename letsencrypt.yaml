---
  - name: "Let's Encrypt"
    hosts:
      - letsencrypt
    gather_facts: yes
    serial: 1
    vars:
      # Let's Encrypt settings
      letsencrypt_dir: /etc/letsencrypt
      letsencrypt_cert_dir: /etc/letsencrypt/certs
      letsencrypt_config_dir: /etc/letsencrypt/config
      # Acme.sh settings
      acme_dns_plugin: dns_gandi_livedns
      acme_server: letsencrypt
    environment:
      # Put your acme.sh environment variables here
      GANDI_LIVEDNS_KEY: put_your_key_here
    tasks:
      - name: "Install git"
        ansible.builtin.package:
          name: git
          state: present
      - name: "Clone git repository acme.sh"
        git: 
          repo: https://github.com/acmesh-official/acme.sh.git
          dest: /opt/acme
          clone: yes
          update: yes
      - name: "Create directories"
        file:
          path: /etc/letsencrypt
          state: directory
          owner: root
          mode: u=rwx,g=rx,o=rx
        with_items:
          certs
          config
      - name: "Generate Let's Encrypt certificate"
        command: |
          /opt/acme/acme.sh --issue --server {{ acme_server }} --cert-home {{ letsencrypt_cert_dir }} --config-home {{ letsencrypt_config_dir }} --dns {{ acme_dns_plugin }} --domain {{ inventory_hostname }}
        ignore_errors: yes
      - name: "Fix key permissions"
        file:
          path: "{{ letsencrypt_cert_dir }}/{{ inventory_hostname }}/{{ inventory_hostname }}.key"
          mode: u=rw,g=r,o=r
        when: change_key_permission == 'yes'
      - name: "Reload NGINX"
        ansible.builtin.service:
          name: nginx
          state: reloaded
        when: nginx == 'yes'
      - name: "Reload Apache"
        ansible.builtin.service:
          name: apache24
          state: reloaded
        when: apache == 'yes'

